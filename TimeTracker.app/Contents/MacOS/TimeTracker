#!/bin/bash
# Time Tracker - macOS App Launcher (auto-configured by install_app.sh)

BUNDLE_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
RESOURCES_DIR="$BUNDLE_DIR/Contents/Resources"

# Use the Python framework executable (required for macOS menu bar / AppKit)
# The framework Python is needed so the process can connect to the window server
PYTHON="/opt/homebrew/Cellar/python@3.14/3.14.3_1/Frameworks/Python.framework/Versions/Current/Resources/Python.app/Contents/MacOS/Python"

# Fallback to regular python3 if framework exe is missing
if [ ! -x "$PYTHON" ]; then
    for py in /opt/homebrew/bin/python3 /usr/local/bin/python3; do
        if [ -x "$py" ]; then
            PYTHON="$py"
            break
        fi
    done
fi

if [ -z "$PYTHON" ] || [ ! -x "$PYTHON" ]; then
    osascript -e 'display alert "Time Tracker Error" message "Python 3.10+ not found. Please run install_app.sh again." as critical'
    exit 1
fi

# Install rumps if missing
if ! "$PYTHON" -c "import rumps" 2>/dev/null; then
    osascript -e 'display notification "Installing Time Tracker dependencies..." with title "Time Tracker"'
    "$PYTHON" -m pip install rumps --quiet 2>/dev/null ||     "$PYTHON" -m pip install rumps --user --quiet 2>/dev/null ||     "$PYTHON" -m pip install rumps --break-system-packages --quiet 2>/dev/null
fi

# Kill any existing instance
pkill -f "timetracker_menu.py" 2>/dev/null
sleep 0.5

# Launch menu bar app
exec "$PYTHON" "$RESOURCES_DIR/timetracker_menu.py"
